extends ../layout

block content

  header.header
    .container
      .header-content
        a.logo(href='/')
          i.fas.fa-spray-can
          span Клининговая компания

  .page-container
    .navigation-links
      a.back-link(href='/clients') ← Назад к списку клиентов
    
    .content-card
      .profile-header
        h1.page-title= title
  
      .profile-content
        form#clientForm.profile-form
          .form-section
            h2.section-title Основная информация
            
            .form-grid
              .form-group
                label(for="editfio") ФИО:
                if can_view_clients
                  input#editfio(type='text', value=client.fio, name="fio")
                else
                  .form-value= client.fio
              
              .form-group
                label(for="editphone") Телефон:
                if can_view_clients
                  input#editphone(type='text', value=client.phone, name="phone")
                else
                  .form-value= client.phone
              
              .form-group
                label(for="editemail") Email:
                if can_view_clients
                  input#editemail(type='email', value=client.email || '', name="email")
                else
                  .form-value= client.email || 'Нет'
              
              .form-group
                label(for="edittype_l") Тип лица:
                if can_view_clients
                  select#edittype_l(name="type_l")
                    option(value="") Выберите тип
                    option(value="Физическое лицо" selected=client.type_l === "Физическое лицо") Физическое лицо
                    option(value="Юридическое лицо" selected=client.type_l === "Юридическое лицо") Юридическое лицо
                else
                  .form-value= client.type_l
              
              .form-actions
                .buttons-row
                  if can_view_clients
                    button.primary-button#editSaveButton(type="button") Сохранить изменения
                    button.danger-button#deleteButton(type="button") Удалить клиента
                  else
                    .no-permission-message У вас нет прав для редактирования профиля        

        if userData
          .info-section
            h2.section-title Данные пользователя в системе
            
            .info-grid
              .info-item
                .info-label ID пользователя:
                .info-value= userData.user_id
              .info-item
                .info-label Логин:
                .info-value= userData.login || 'Не указан'
              .info-item
                .info-label Роль:
                .info-value= userData.role || 'Не указана'
        else
          .info-section
            .info-card
              .empty-message Данные пользователя не найдены в системе
        
        .info-section
          h2.section-title Объекты клининга
          
          if can_view_clients
            .object-actions
              button.primary-button#addObjectButton Добавить объект
          
          if cleanObjects && cleanObjects.length > 0
            .table-container
              table.data-table
                thead
                  tr 
                    th Тип объекта
                    th Адрес
                    th Площадь (м²)
                    th Описание
                    th Действия
                tbody
                  each obj in cleanObjects
                    tr
                      td= obj.type_co
                      td= obj.address
                      td= obj.squaremeterage
                      td= obj.description || 'Нет'
                      td
                        .action-buttons
                          button.edit-object-btn(data-id=obj.id, data-type=obj.type_co, data-address=obj.address, data-squaremeterage=obj.squaremeterage, data-description=obj.description || '', data-floorplan=obj.floorplan || '') Редактировать
                          button.delete-object-btn(data-id=obj.id) Удалить
          else
            .info-card
              .empty-message У клиента нет объектов клининга

    #deleteConfirmModal.modal-window(style="display: none;")
      .modal-content
        .modal-header
          h3 Подтверждение удаления
          button.modal-close#deleteModalClose ×
        .modal-body
          .warning-message
            .warning-icon ⚠️
            .warning-text
              h4 Вы уверены, что хотите удалить клиента?
              p
                strong= client.fio
              p Это действие нельзя отменить. Все данные клиента будут удалены безвозвратно.
        .modal-footer
          button.secondary-button#cancelDelete Отмена
          button.danger-button#confirmDelete Удалить

    #objectModal.modal-window(style="display: none;")
      .modal-content
        .modal-header
          h3#objectModalTitle Добавить объект
          button.modal-close#objectModalClose ×
        .modal-body
          form#objectForm.modal-form
            input#objectId(type="hidden", value="")
            .form-group
              label(for="objectType") Тип объекта *
              select#objectType(name="type_co", required)
                option(value="") Выберите тип
                each type in clean_object_types
                  option(value=type)= type
            .form-group
              label(for="objectAddress") Адрес *
              input#objectAddress(type="text", name="address", required)
            .form-group
              label(for="objectSquareMeterage") Площадь (м²) *
              input#objectSquareMeterage(type="number", name="squaremeterage", required)
            .form-group
              label(for="objectDescription") Описание
              textarea#objectDescription(name="description", rows="3")
            .form-group
              label(for="objectFloorPlan") План этажа
              input#objectFloorPlan(type="text", name="floorplan")
        .modal-footer
          button.secondary-button#cancelObjectForm Отмена
          button.primary-button#submitObjectForm Сохранить

  style.
    /* Общие стили */
    .page-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    .page-title {
      font-size: 32px;
      color: #5C4EAE;
      margin-bottom: 30px;
      font-weight: 600;
    }
    
    .content-card {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(92, 78, 174, 0.1);
    }
    
    /* Навигация */
    .navigation-links {
      margin-bottom: 20px;
    }
    
    .back-link {
      color: #6C5FBC;
      text-decoration: none;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: color 0.3s ease;
    }
    
    .back-link:hover {
      color: #5C4EAE;
      text-decoration: underline;
    }
    
    /* Заголовки секций */
    .section-title {
      font-size: 24px;
      color: #5C4EAE;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 2px solid #6C5FBC;
      font-weight: 600;
    }
    
    /* Форма профиля */
    .profile-form {
      margin-bottom: 40px;
    }
    
    .form-section {
      margin-bottom: 40px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-group label {
      font-weight: 600;
      color: #333;
      font-size: 15px;
    }
    
    .form-group input,
    .form-group select {
      padding: 12px 16px;
      border: 2px solid #EAEAEA;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: #FFFFFF;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #6C5FBC;
      box-shadow: 0 0 0 3px rgba(108, 95, 188, 0.1);
    }
    
    .form-group input:disabled,
    .form-group select:disabled {
      background-color: #F8F8F8;
      color: #666;
      cursor: not-allowed;
    }
    
    .form-value {
      padding: 12px;
      background-color: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #EAEAEA;
      color: #333;
      min-height: 46px;
      display: flex;
      align-items: center;
    }
    
    /* Кнопки */
    .primary-button {
      background-color: #6C5FBC;
      color: white;
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      max-width: 180px;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .primary-button:hover {
      background-color: #5C4EAE;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(108, 95, 188, 0.3);
    }
    
    .secondary-button {
      background-color: #f0f0f0;
      color: #333;
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .secondary-button:hover {
      background-color: #DDD;
      transform: translateY(-2px);
    }
    
    .danger-button {
      background-color: #f44336;
      color: white;
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      max-width: 280px;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .danger-button:hover {
      background-color: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(244, 67, 54, 0.3);
    }
    
    .form-actions {
      margin-top: 30px;
    }
    
    .buttons-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .no-permission-message {
      padding: 20px;
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      color: #856404;
      text-align: center;
    }
    
    /* Информационные секции */
    .info-section {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 1px solid #EAEAEA;
    }
    
    .info-card {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .info-item {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #EAEAEA;
    }
    
    .info-label {
      font-weight: 600;
      color: #5C4EAE;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .info-value {
      color: #333;
      font-size: 16px;
    }
    
    .empty-message {
      color: #666;
      font-size: 16px;
      text-align: center;
    }
    
    /* Действия с объектами */
    .object-actions {
      margin-bottom: 20px;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .edit-object-btn,
    .delete-object-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .edit-object-btn {
      background-color: #4CAF50;
      color: white;
    }
    
    .edit-object-btn:hover {
      background-color: #45a049;
      transform: translateY(-2px);
    }
    
    .delete-object-btn {
      background-color: #f44336;
      color: white;
    }
    
    .delete-object-btn:hover {
      background-color: #d32f2f;
      transform: translateY(-2px);
    }
    
    /* Таблица */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #5C4EAE;
      color: #6C5FBC;
      margin-top: 15px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table thead {
      background-color: #5C4EAE;
      color: black;
    }
    
    .data-table th {
      padding: 18px 20px;
      text-align: left;
      font-weight: 600;
      color: black;
      font-size: 16px;
      border-bottom: 2px solid #4A3E9C;
    }
    
    .data-table tbody tr:nth-child(odd) td {
      background-color: #FFFFFF;
    }
    
    .data-table tbody tr:nth-child(even) td {
      background-color: #F8F8F8;
    }
    
    .data-table td {
      padding: 16px 20px;
      border-bottom: 1px solid #DDD;
      color: #000000;
      font-size: 15px;
      vertical-align: middle;
    }
    
    .data-table tbody tr:hover {
      background-color: rgba(108, 95, 188, 0.05);
    }
    
    .data-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Модальные окна */
    .modal-window {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      width: 800px !important;
      max-width: 95vw !important;
      background: #FFFFFF !important;
      border-radius: 12px !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px 30px;
      border-bottom: 1px solid #6C5FBC;
      background-color: #5C4EAE;
      border-radius: 12px 12px 0 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .modal-header h3 {
      color: white;
      margin: 0;
      font-size: 22px;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.3s ease;
    }
    
    .modal-close:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
      padding: 30px !important;
    }
    
    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid #6C5FBC;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }
    
    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .modal-form textarea {
      padding: 12px 16px;
      border: 2px solid #EAEAEA;
      border-radius: 8px;
      font-size: 15px;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    .modal-form textarea:focus {
      outline: none;
      border-color: #6C5FBC;
      box-shadow: 0 0 0 3px rgba(108, 95, 188, 0.1);
    }
    
    /* Сообщения с предупреждениями */
    .warning-message {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      padding: 20px;
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .warning-icon {
      font-size: 24px;
    }
    
    .warning-text h4 {
      margin-top: 0;
      color: #856404;
      margin-bottom: 10px;
    }
    
    .warning-text p {
      margin: 5px 0;
      color: #333;
    }

  script(src="https://code.jquery.com/jquery-3.6.0.min.js")
  script.
    $(document).ready(function() {
      const clientId = window.location.pathname.split('/').pop();
      let currentObjectId = null;

      // Сохранение изменений клиента
      $('#editSaveButton').click(function(e) {
        e.preventDefault();
        
        const formData = {
          fio: $('#editfio').val(),
          phone: $('#editphone').val(),
          email: $('#editemail').val(),
          type_l: $('#edittype_l').val(),
          id_pol: $('#editid_pol').val()
        };
        
        if (!formData.fio || !formData.phone || !formData.type_l) {

          return;
        }
        
        if (formData.id_pol === '') {
          formData.id_pol = null;
        }
        
        const button = $(this);
        button.prop('disabled', true).text('Сохранение...');
        
        $.ajax({
          type: 'POST',
          data: JSON.stringify(formData),
          contentType: 'application/json',
          url: '/clients/update/' + clientId,
          dataType: 'JSON'
        }).done(function(response) {
          if (response.msg === '') {

            window.location.reload();
          } else {

          }
        }).fail(function(xhr, status, error) {
          console.error('Error:', error);

        }).always(function() {
          button.prop('disabled', false).text('Сохранить изменения');
        });
      });
      
      // Удаление клиента
      $('#deleteButton').click(function() {
        $('#deleteConfirmModal').show();
      });
      
      $('#deleteModalClose, #cancelDelete').click(function() {
        $('#deleteConfirmModal').hide();
      });
      
      $('#confirmDelete').click(function() {
        const button = $(this);
        button.prop('disabled', true).text('Удаление...');
        
        $.ajax({
          type: 'DELETE',
          contentType: 'application/json',
          url: '/clients/delete/' + clientId,
          dataType: 'JSON'
        }).done(function(response) {
          if (response.msg === '') {

            window.location.href = '/clients';
          } else {

            $('#deleteConfirmModal').hide();
          }
        }).fail(function(xhr, status, error) {
          console.error('Error:', error);

        }).always(function() {
          button.prop('disabled', false).text('Удалить');
        });
      });
      
      // Объекты клининга
      $('#addObjectButton').click(function() {
        $('#objectModalTitle').text('Добавить объект');
        $('#objectForm')[0].reset();
        $('#objectId').val('');
        currentObjectId = null;
        $('#objectModal').show();
      });
      
      // Редактирование объекта
      $(document).on('click', '.edit-object-btn', function() {
        const objectId = $(this).data('id');
        currentObjectId = objectId;
        
        $('#objectModalTitle').text('Редактировать объект');
        $('#objectId').val(objectId);
        $('#objectType').val($(this).data('type'));
        $('#objectAddress').val($(this).data('address'));
        $('#objectSquareMeterage').val($(this).data('squaremeterage'));
        $('#objectDescription').val($(this).data('description'));
        $('#objectFloorPlan').val($(this).data('floorplan'));
        
        $('#objectModal').show();
      });
      
      // Удаление объекта
      $(document).on('click', '.delete-object-btn', function() {
        const objectId = $(this).data('id');
        const objectAddress = $(this).closest('tr').find('td:nth-child(3)').text();
        
        if (confirm('Вы уверены, что хотите удалить объект по адресу "' + objectAddress + '"?')) {
          $.ajax({
            type: 'DELETE',
            contentType: 'application/json',
            url: '/clients/' + clientId + '/clean-objects/' + objectId,
            dataType: 'JSON'
          }).done(function(response) {
            if (response.msg === '') {

              window.location.reload();
            } else {

            }
          }).fail(function(xhr, status, error) {
            console.error('Error:', error);

          });
        }
      });
      
      // Закрытие модального окна объекта
      $('#objectModalClose, #cancelObjectForm').click(function() {
        $('#objectModal').hide();
      });
      
      // Сохранение объекта
      $('#submitObjectForm').click(function(e) {
        e.preventDefault();
        
        const objectData = {
          type_co: $('#objectType').val(),
          address: $('#objectAddress').val(),
          squaremeterage: $('#objectSquareMeterage').val(),
          description: $('#objectDescription').val(),
          floorplan: $('#objectFloorPlan').val()
        };
        
        if (!objectData.type_co || !objectData.address || !objectData.squaremeterage) {

          return;
        }
        
        const button = $(this);
        button.prop('disabled', true).text('Сохранение...');
        
        const url = currentObjectId 
          ? '/clients/' + clientId + '/clean-objects/' + currentObjectId
          : '/clients/' + clientId + '/clean-objects';
        
        $.ajax({
          type: 'POST',
          data: JSON.stringify(objectData),
          contentType: 'application/json',
          url: url,
          dataType: 'JSON'
        }).done(function(response) {
          if (response.msg === '') {

            window.location.reload();
          } else {
  
          }
        }).fail(function(xhr, status, error) {
          console.error('Error:', error);

        }).always(function() {
          button.prop('disabled', false).text('Сохранить');
        });
      });
      
      // Закрытие модальных окон при клике вне их
      $(window).click(function(event) {
        if ($(event.target).hasClass('modal-window')) {
          $(event.target).hide();
        }
      });
    });