extends ../layout

block content

  // Навигационное поле
  header.header
    .container
      .header-content
        a.logo(href='/')
          i.fas.fa-spray-can
          span Клининговая компания

  .page-container
    h1.page-title= title
    
    // Панель действий и фильтры
    .actions-panel
      if can_view_orders
        button.primary-button(id='create_order') Создать заказ
    
    // Фильтры
    .filters-card
      form#filtersForm(method='GET' action='/orders')
        .filter-grid
          .form-group
            label(for="filter_status") Статус заказа
            select#filter_status(name="status")
              option(value="all") Все статусы
              each status in statuses
                option(value=status.status selected=(currentFilters.status === status.status))= status.status
          
          .form-group
            label(for="filter_client") ФИО клиента
            input#filter_client(type="text" name="client_fio" placeholder="Поиск по ФИО..." value=currentFilters.client_fio)
          
          .form-group
            label &nbsp;
            .filter-buttons
              button.secondary-button(type="submit") Применить
              a.button-link(href='/orders') Сбросить
    
    .content-card
      if orders && orders.length > 0
        .table-container
          table.data-table
            thead
              tr 
                th ID
                th Статус
                th Дата создания
                th Клиент
                th Общая стоимость
                th Плановая дата
                th Площадь объекта
                th Описание
            tbody
              each order in orders
                tr
                  td
                    a(href='/orders/' + order.id)= order.id
                  td
                    if order.status
                      span.status-badge(class=order.status.replace(/\s+/g, '-').toLowerCase())= order.status
                    else
                      | -
                  td
                    if order.creationdate
                      = new Date(order.creationdate).toLocaleDateString('ru-RU')
                    else
                      | -
                  td
                    a(href='/orders/' + order.id)= order.client_fio || 'Клиент #' + order.id_client
                  td
                    if order.totalcost
                      = order.totalcost.toLocaleString('ru-RU') + ' ₽'
                    else
                      | -
                  td
                    if order.planneddate
                      = new Date(order.planneddate).toLocaleDateString('ru-RU')
                    else
                      | -
                  td= order.object_square ? order.object_square + ' м²' : '-'
                  td.description-cell= order.description || '-'
        .table-footer
          .table-info Найдено заказов: #{orders.length}
      else
        .empty-state
          p Нет заказов в базе данных
          if currentFilters.status !== 'all' || currentFilters.client_fio
            p Попробуйте изменить параметры фильтрации
            a.button-link(href='/orders') Показать все заказы

    // Модальное окно для создания заказа
    div#create_order_popup.modal-window(style="display:none")
      .modal-content(style="width: 800px; max-width: 90vw;")
        .modal-header
          h3 Создать заказ
          button.modal-close#create_order_popup_close ×
        .modal-body
          form.modal-form#orderForm
            .form-grid
              .form-group
                label(for="inpstatus") Статус *
                select#inpstatus(name="id_status" required)
                  option(value="Новый") Новый
            
            .form-section
              h4.section-subtitle Клиент и объект уборки
              
              .client-selection
                .form-group
                  label(for="inpclient") Клиент *
                  .client-select-wrapper
                    select#inpclient(name="id_client" required)
                      option(value="") Выберите клиента
                    button.type-button#addClientBtn(type="button") + Новый
                
                .form-group
                  label(for="inpclean_object") Объект уборки
                  .object-select-wrapper
                    select#inpclean_object(name="id_clean_object")
                      option(value="") Выберите объект
                    button.type-button#addObjectBtn(type="button") + Новый
            
            .form-section
              h4.section-subtitle Детали заказа
              .form-grid
                .form-group
                  label(for="inpcreationDate") Дата создания
                  input#inpcreationDate(type="date" name="creationDate")
                .form-group
                  label(for="inpplannedDate") Плановая дата выполнения
                  input#inpplannedDate(type="date" name="plannedDate")
                .form-group.full-width
                  label(for="inpdescription") Описание заказа
                  textarea#inpdescription(placeholder="Описание заказа..." rows="3" name="description")
            
            .form-section
              h4.section-subtitle Услуги в заказе
              #services-container
                .service-item
                  .service-header
                    label Услуга 1 *
                    button.type-button.remove-service(type="button") ✕
                  .service-row
                    .form-group
                      select.service-select(name="service[]" required)
                        option(value="") Выберите услугу
                    .form-group
                      .price-display
                        .price-label Цена:
                        span.price-value 0 ₽
                    input.service-id(type="hidden" name="service_id[]")
                    input.service-price(type="hidden" name="service_price[]")
              
              .form-group
                button.secondary-button#addServiceBtn(type="button") + Добавить услугу
              
              .total-cost-display
                h4 Итого: 
                  span#total-cost 0 ₽

        .modal-footer
          button.secondary-button#cancel_create_order Отменить
          button.primary-button#submit_create_order Создать заказ

    // Модальное окно для создания клиента
    div#create_client_popup.modal-window(style="display:none")
      .modal-content
        .modal-header
          h3 Создать нового клиента
          button.modal-close#create_client_popup_close ×
        .modal-body
          form#clientForm
            .form-group
              label(for="client_fio") ФИО *
              input#client_fio(type="text" placeholder="Иванов Иван Иванович" required)
            .form-group
              label(for="client_phone") Телефон *
              input#client_phone(type="text" placeholder="89991234567" required)
            .form-group
              label(for="client_email") Email
              input#client_email(type="email" placeholder="client@example.com")
            .form-group
              label(for="client_type") Тип клиента
              select#client_type
                option(value="Физическое лицо") Физическое лицо
                option(value="Юридическое лицо") Юридическое лицо
            .form-group
              label(for="client_login") Логин для входа *
              input#client_login(type="text" placeholder="Логин" required)
            .form-group
              label(for="client_password") Пароль *
              input#client_password(type="password" placeholder="Пароль" required)
        .modal-footer
          button.secondary-button#cancel_create_client Отмена
          button.primary-button#submit_create_client Создать

    // Модальное окно для создания объекта уборки
    div#create_object_popup.modal-window(style="display:none")
      .modal-content
        .modal-header
          h3 Создать объект уборки
          button.modal-close#create_object_popup_close ×
        .modal-body
          form#objectForm
            .form-group
              label(for="object_client") Клиент *
              select#object_client(required)
                option(value="") Выберите клиента
            .form-group
              label(for="object_type") Тип объекта *
              select#object_type(required)
                option(value="Квартира") Квартира
                option(value="Офисное помещение") Офисное помещение
                option(value="Дом/танхаус") Дом/танхаус
                option(value="Другое") Другое
            .form-group
              label(for="object_address") Адрес *
              input#object_address(type="text" placeholder="ул. Ленина, д. 10, кв. 25" required)
            .form-group
              label(for="object_square") Площадь (м²)
              input#object_square(type="number" placeholder="65")
            .form-group
              label(for="object_description") Описание
              textarea#object_description(rows="3" placeholder="Описание объекта...")
        .modal-footer
          button.secondary-button#cancel_create_object Отмена
          button.primary-button#submit_create_object Создать

  script(src='/javascripts/orders.js')

  style.
    /* Общие стили */
    .page-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    .page-title {
      font-size: 32px;
      color: #5C4EAE;
      margin-bottom: 30px;
      font-weight: 600;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.новый { background-color: #e3f2fd; color: #1976d2; }
    .status-badge.обработка-заказа-менеджером { background-color: #fff3e0; color: #f57c00; }
    .status-badge.на-согласовании-зн { background-color: #f3e5f5; color: #7b1fa2; }
    .status-badge.в-ожидании { background-color: #fff3e0; color: #f57c00; }
    .status-badge.заказ-в-работе { background-color: #e8f5e8; color: #388e3c; }
    .status-badge.заказ-выполнен { background-color: #e8f5e8; color: #388e3c; }
    .status-badge.на-согласовании-акта { background-color: #fff3e0; color: #f57c00; }
    .status-badge.акт-согласован { background-color: #e8f5e8; color: #388e3c; }
    .status-badge.акт-не-согласован { background-color: #ffebee; color: #d32f2f; }
    .status-badge.выставлен-счет-на-оплату { background-color: #fff3e0; color: #f57c00; }
    .status-badge.заказ-оплачен { background-color: #e8f5e8; color: #388e3c; }
    .status-badge.завершён { background-color: #f5f5f5; color: #616161; }

    .description-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .content-card {
      background: #FFFFFF;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(92, 78, 174, 0.1);
    }
    
    /* Панель действий */
    .actions-panel {
      margin-bottom: 25px;
    }
    
    /* Кнопки */
    .primary-button {
      background-color: #6C5FBC;
      color: white;
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .primary-button:hover {
      background-color: #5C4EAE;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(108, 95, 188, 0.3);
    }

    .type-button {
      background-color: #6C5FBC;
      color: white;
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .type-button:hover {
      background-color: #5C4EAE;
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(108, 95, 188, 0.3);
    }
    
    .secondary-button {
      background-color: #6C5FBC;
      color: #333;
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .secondary-button:hover {
      background-color: #DDD;
      transform: translateY(-2px);
    }
    
    /* Таблица */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid #5C4EAE;
      color: #6C5FBC;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table thead {
      background-color: #5C4EAE; /* Тёмный фиолетовый */
    }
    
    .data-table th {
      padding: 18px 20px;
      text-align: left;
      font-weight: 600;
      color: #FFFFFF; /* Белый */
      font-size: 16px;
      border-bottom: 2px solid #4A3E9C; /* Ещё темнее для контраста */
      background-color: #5C4EAE;
    }
    
    /* Чётные строки - светло-серые, нечётные - белые */
    .data-table tbody tr:nth-child(odd) td {
      background-color: #FFFFFF;
    }
    
    .data-table tbody tr:nth-child(even) td {
      background-color: #F8F8F8;
    }
    
    .data-table td {
      padding: 16px 20px;
      border-bottom: 1px solid #DDD;
      color: #000000; /* Чёрный текст для максимального контраста */
      font-size: 15px;
    }
        
    .data-table tbody tr:hover {
      background-color: rgba(108, 95, 188, 0.05);
    }
    
    .data-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .data-table a {
      color: #6C5FBC;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
    }
    
    .data-table a:hover {
      color: #5C4EAE;
      text-decoration: underline;
    }
    
    .form-group select{
      padding: 14px 16px;
      border: 2px solid #EAEAEA;
      border-radius: 8px;
      font-size: 16px;
      max-width: 520px;
      background: #FFFFFF;
      transition: all 0.3s ease;
    }
    
    .form-group select:focus {
      outline: none;
      border-color: #6C5FBC;
      box-shadow: 0 0 0 3px rgba(108, 95, 188, 0.1);
    }
    
    .form-group select:disabled {
      background-color: #F8F8F8;
      color: #666;
      cursor: not-allowed;
    }  

    /* Состояние пустого списка */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 18px;
    }
    
    /* Модальное окно */
    .modal-window {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      width: 800px !important; /* Широкая ширина с !important */
      max-width: 95vw !important;
      background: #FFFFFF !important;
      border-radius: 12px !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2) !important;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 25px 30px;
      border-bottom: 1px solid #6C5FBC;
      background-color: #5C4EAE;
      border-radius: 12px 12px 0 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .modal-header h3 {
      color: white;
      margin: 0;
      font-size: 22px;
    }

    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.3s ease;
    }

    .modal-close:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .modal-body {
      padding: 30px !important;
    }

    .modal-footer {
      padding: 20px 30px;
      border-top: 1px solid #6C5FBC;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    /* Форма */
    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-weight: 600;
      color: #333;
      font-size: 15px;
    }

    .form-group input {
      padding: 12px 16px;
      border: 1px solid #DDD;
      border-radius: 6px;
      font-size: 15px;
      transition: border-color 0.3s ease;
      width: 100%; /* Чтобы поля ввода занимали всю доступную ширину */
    }

    .form-group input:focus {
      outline: none;
      border-color: #6C5FBC;
      box-shadow: 0 0 0 3px rgba(108, 95, 188, 0.1);
    }

    .form-group input::placeholder {
      color: #999;
    }